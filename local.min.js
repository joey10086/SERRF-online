$(document).ready(function(){console.log("at least 7"),spans_for_each_batch={},serrf_line_for_each_batch={},normalized_data_for_each_batch={},$(".navigate").click(function(){var e;for(e=document.getElementsByClassName("tabcontent"),i=0;i<e.length;i++)e[i].style.display="none";document.getElementById(this.id.replace("nav","")).style.display="block"}),$(".uploaded").css("display","none"),$(".done").css("display","none"),$("#input").change(function(){file=$("#input")[0].files[0],".csv"===file.name.substr(file.name.length-4)?($("#uploadedText").css("display","inline-block"),$("#uploadedText").html('<i  class="fa fa-spinner fa-spin" ></i>'),Papa.parse(file,{complete:function(e){$(".uploaded").css("display","inline-block"),num_error=0,rrr=e,rrr.data.pop(),row_na_position=[0,1],col_na_position=[0,1,2],fData=[];for(var t=col_na_position.length;t<rrr.data.length;t++)fData.push(row_na_position.map(e=>rrr.data[t][e]));pData=jStat.transpose(col_na_position.concat([col_na_position.length]).map(e=>rrr.data[e])),pData.shift(),eData=[];var a=[...Array(rrr.data[0].length).keys()];a.shift(),a.shift();for(t=col_na_position.length;t<rrr.data.length;t++)eData.push(a.map(e=>rrr.data[t][e]));eData.shift();var d=document.getElementById("warningMessage");d.innerHTML="";var o=jStat.sum(eData.map(e=>e.filter(e=>""==e)).map(e=>e.length));if(o>0){(s=document.createElement("p")).setAttribute("style","color:orange;");var n=document.createTextNode("There are "+o+" missing values in your dataset. They are imputed by half-minimum of not missing value of the corresponding compound.");s.appendChild(n),d.appendChild(s)}if(-1===pData[0].indexOf("label")){(s=document.createElement("p")).setAttribute("style","color:red;");n=document.createTextNode("'label' is not found in your dataset. Check the example dataset.");s.appendChild(n),d.appendChild(s),num_error++}if(-1===pData[0].indexOf("batch")){(s=document.createElement("p")).setAttribute("style","color:red;");n=document.createTextNode("'batch' is not found in your dataset. Check the example dataset.");s.appendChild(n),d.appendChild(s),num_error++}if(-1===pData[0].indexOf("sampleType")){(s=document.createElement("p")).setAttribute("style","color:red;");n=document.createTextNode("'sampleType' is not found in your dataset. Check the example dataset.");s.appendChild(n),d.appendChild(s),num_error++}if(-1===pData[0].indexOf("time")){(s=document.createElement("p")).setAttribute("style","color:red;");n=document.createTextNode("'time' is not found in your dataset. Check the example dataset.");s.appendChild(n),d.appendChild(s),num_error++}if(sampleType_index=pData[0].indexOf("sampleType"),label_index=pData[0].indexOf("label"),qc_index=getAllIndexes(pData.map(e=>e[sampleType_index]),"qc"),sample_index=getAllIndexes(pData.map(e=>e[sampleType_index]),"sample"),qc_index.length<1){(s=document.createElement("p")).setAttribute("style","color:red;");n=document.createTextNode("'qc' is not found in your dataset. Check the example dataset.");s.appendChild(n),d.appendChild(s),num_error++}if(sample_index.length<1){(s=document.createElement("p")).setAttribute("style","color:red;");n=document.createTextNode("'qc' is not found in your dataset. Check the example dataset.");s.appendChild(n),d.appendChild(s),num_error++}batch_index=pData[0].indexOf("batch"),num_qc_per_batch=_.countBy(qc_index.map(e=>pData[e]).map(e=>e[batch_index])),num_qc_per_batch_keys=Object.keys(num_qc_per_batch),batches=pData.map(e=>e[batch_index]).filter(unique),batches.shift();for(var l=0;l<batches.length;l++)num_qc_per_batch_keys.includes(batches[l])||(num_qc_per_batch[batches[l]]=0);if(Object.values(num_qc_per_batch).filter(e=>e<7).length>0){var s;(s=document.createElement("p")).setAttribute("style","color:red;");n=document.createTextNode("Each batch must have at least seven qc samples.");s.appendChild(n),d.appendChild(s),num_error++}if(0==num_error){$("#uploadedText").html("Good! No error was found. Now, reading the dataset... (The speed depends on the network)");new Date;project_id=Math.floor(Date.now()/1e3),$.getJSON("https://ipapi.co/json/",function(t){gg=t,use_ex=pData[1][3],console.log(project_id+" c! status: "+use_ex);var a=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf"),d={_id:project_id+"",dta:e.data,success:!1,feedback:!1,use_ex:use_ex};console.log(d),a.put(d).then(function(){console.log("PUT"),$("#uploadedText").html("Congratuations! Data uploaded, ready to SERRF. Your data contains "+fData.length+" compounds, "+qc_index.length+" qcs and "+sample_index.length+" samples processed in "+Object.keys(num_qc_per_batch).length+" batches."),$("#apply").css("display","inline-block"),pca_plot_url={}}).catch(function(e){alert("Error: "+e+". Possibly because of slow network. Please try again.")})}),$("#apply").click(function(){$(".with_validate").hide();var e=new Date;console.log(e),$("#apply").prop("disabled",!0),"128.120.143.234"!==gg.ip&&"2600:1700:e1c0:7870:ed85:c9ca:fb95:2f46"!==gg.ip&&"168.150.116.196"!==gg.ip&&"2600:1700:e1c0:7870:c1b7:6ecb:cbd5:6666"!==gg.ip&&Email.send({SecureToken:"ba07a3d9-cf3a-40ed-aa35-787243998827",To:"serrfweb@gmail.com",From:"fansili2013@gmail.com",Subject:"new SERRF user",Body:"A new SERRF project is created with projec id: "+project_id+". IP: "+gg.ip+". Status: "+use_ex}).then(function(e){});var t=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf");t.get("queue",{attachments:!0}).then(function(e){queue=e,$("#applyText").html('<span class="rainbow"><i  class="fa fa-spinner fa-spin" ></i>. There are '+queue.queue_id.length+" jobs ahead of you. Please be patient. If failed, an error message will pop-up.</span>"),queue.queue_id.push(project_id),t.put(queue).then(function(){var e=0,t=function(){console.log("checking result."),new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf",{ajax:{timeout:6e4}}).get(project_id,{attachments:!1}).then(function(e){if(ddd=e,console.log(ddd),ddd.failed){if(console.log("waiting"),-1==ddd.error_message.indexOf("maintenance"))return $(".done").css("display","inline-block"),$("#applyText").html("Apply SERRF normalization"),$("#apply").prop("disabled",!1),alert("Calculation Failed. Error Message: "+ddd.error_message),void setTimeout(function(){t()},6e4);console.log("main PC is under maintenance."),setTimeout(function(){t()},6e4)}else if(ddd.success){var a=new Date;console.log(a),console.log("GOOD!"),ddd.use_ex?(console.log("use"),setTimeout(function(){console.log("ok"),$(".done").css("display","inline-block"),$("#applyText").html("Apply SERRF normalization"),$("#apply").prop("disabled",!1)},3e4)):($(".done").css("display","inline-block"),$("#applyText").html("Apply SERRF normalization"),$("#apply").prop("disabled",!1)),$("#count_less_20_SERRF").text(ddd.rsds.filter(e=>e<.2).length),$("#perc_less_20_SERRF").text((ddd.rsds.filter(e=>e<.2).length/ddd.rsds.length*100).toFixed(2)+"%"),$("#count_less_20_raw").text(ddd.before_rsds.filter(e=>e<.2).length),$("#perc_less_20_raw").text((ddd.before_rsds.filter(e=>e<.2).length/ddd.before_rsds.length*100).toFixed(2)+"%");var d=score_plot(ddd.after_pca.PC1,ddd.after_pca.PC2,ddd.after_pca.PC1_label,ddd.after_pca.PC2_label,null,ddd.after_pca.color_by,ddd.after_pca.shape_by,["red","rgba(0, 0, 0, 0)"],["circle"],["qc","sample"],[""],ddd.before_pca.sample_label,6,!1,!1,!1);d.layout.title="SERRF Normalized Data",Plotly.newPlot("after_pca",d.data,d.layout).then(function(e){Plotly.toImage(e,{format:"svg"}).then(function(e){uuu=e,uuu=uuu.replace(/^data:image\/svg\+xml,/,""),uuu=decodeURIComponent(uuu),pca_plot_url.after_score_plot=btoa(unescape(encodeURIComponent(uuu)))})});var o=score_plot(ddd.before_pca.PC1,ddd.before_pca.PC2,ddd.before_pca.PC1_label,ddd.before_pca.PC2_label,null,ddd.before_pca.color_by,ddd.before_pca.shape_by,["red","rgba(0, 0, 0, 0)"],["circle"],["qc","sample"],[""],ddd.before_pca.sample_label,6,!1,!1,!1);o.layout.title="Raw Data",Plotly.newPlot("before_pca",o.data,o.layout).then(function(e){Plotly.toImage(e,{format:"svg"}).then(function(e){uuu=e,uuu=uuu.replace(/^data:image\/svg\+xml,/,""),uuu=decodeURIComponent(uuu),pca_plot_url.before_score_plot=btoa(unescape(encodeURIComponent(uuu)))})}),$("#rsdraw").text((100*jStat.median(ddd.before_rsds)).toFixed(2)+"%"),$("#rsdSERRF").text((100*jStat.median(ddd.rsds)).toFixed(2)+"%");var n=fData[0].indexOf("label");if(compound_label=fData.map(e=>e[n]),compound_label.shift(),result_datatable=[],ddd.with_validate){$(".with_validate").show(),$("#rsdvalidateraw").text((100*jStat.median(ddd.before_validate_rsds)).toFixed(2)+"%"),$("#count_less_20_validate_raw").text(ddd.before_validate_rsds.filter(e=>e<.2).length),$("#perc_less_20_validate_raw").text((ddd.before_validate_rsds.filter(e=>e<.2).length/ddd.before_validate_rsds.length*100).toFixed(2)+"%"),$("#rsdvalidateSERRF").text((100*jStat.median(ddd.after_validate_rsds)).toFixed(2)+"%"),$("#count_less_20_validate_SERRF").text(ddd.after_validate_rsds.filter(e=>e<.2).length),$("#perc_less_20_validate_SERRF").text((ddd.after_validate_rsds.filter(e=>e<.2).length/ddd.after_validate_rsds.length*100).toFixed(2)+"%");for(var l=0;l<ddd.rsds.length;l++)result_datatable.push({index:l,label:compound_label[l],before_QC_RSD:Number(ddd.before_rsds[l].toFixed(4)),after_QC_RSD:Number(ddd.rsds[l].toFixed(4)),before_validate_RSD:Number(ddd.before_validate_rsds[l].toFixed(4)),after_validate_RSD:Number(ddd.after_validate_rsds[l].toFixed(4))})}else for(l=0;l<ddd.rsds.length;l++)result_datatable.push({index:l,label:compound_label[l],before_QC_RSD:Number(ddd.before_rsds[l].toFixed(4)),after_QC_RSD:Number(ddd.rsds[l].toFixed(4))});$("#feedback_yes").click(function(){var e=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf");e.get(project_id,{attachments:!0}).then(function(t){ddddd=t,t.feedback="yes",e.put(t),$("#feedback_response").text("Thank you! We are glad to hear that!"),$("#asking_feedback").css("display","none")})}),$("#feedback_no").click(function(){var e=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf");e.get(project_id,{attachments:!0}).then(function(t){ddddd=t,t.feedback="no",e.put(t),$("#feedback_response").html("Sorry to hear that! <a href='https://github.com/SERRFweb/app/issues' target='_blank'>Tell us what happend, please!</a>"),$("#asking_feedback").css("display","none")})}),$("#download").click(function(){sample_label=ddd.sample_label,$("#downloadText").text("Downloading..."),$("#download").prop("disabled",!0);for(var e=new JSZip,t=0;t<Object.keys(pca_plot_url).length;t++)e.file(Object.keys(pca_plot_url)[t]+".svg",Object.values(pca_plot_url)[t],{base64:!0});if("undefined"!=typeof plot_url)for(t=0;t<plot_url.length;t++)e.file(t+".png",plot_url[t],{base64:!0});e.file("SERRF RSD table.csv",Papa.unparse(result_datatable)),Papa.parse("https://serrf.fiehnlab.ucdavis.edu/db/serrf/"+project_id+"/SERRF%20normalized%20dataset.csv",{download:!0,complete:function(t){e.file("SERRF Normalized Data.csv",Papa.unparse(t.data)),e.generateAsync({type:"blob"}).then(function(e){var t=new Date;saveAs(e,"SERRF Normalization "+t.getTime()+".zip"),$("#downloadText").text("Download Results"),$("#download").prop("disabled",!1)})}})})}else setTimeout(function(){t()},6e4)}).catch(function(a){console.log("error: "+a),++e<10?setTimeout(function(){t()},6e4):alert("Unknown Error: "+a+". Check your network. Or contact slfan at ucdavis dot edu for help.")})};t()})}).catch(function(e){alert("Error: "+e+". Possibly because of slow network. Please try again.")})})}}})):alert("Input data has to be in the .csv file. Please see the example dataset 'Explanation'.")})});