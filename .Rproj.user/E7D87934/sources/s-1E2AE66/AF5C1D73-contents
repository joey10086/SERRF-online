$(document).ready(function(){console.log(1548435788),spans_for_each_batch={},serrf_line_for_each_batch={},normalized_data_for_each_batch={},$(".navigate").click(function(){var d;for(d=document.getElementsByClassName("tabcontent"),i=0;i<d.length;i++)d[i].style.display="none";var e=this;document.getElementById(e.id.replace("nav","")).style.display="block"}),$(".uploaded").css("display","none"),$(".done").css("display","none"),$("#input").change(function(){return file=$("#input")[0].files[0],".csv"===file.name.substr(file.name.length-4)?void($("#uploadedText").css("display","inline-block"),$("#uploadedText").html("<i  class=\"fa fa-spinner fa-spin\" ></i>"),Papa.parse(file,{complete:function(d){$(".uploaded").css("display","inline-block"),num_error=0,rrr=d,rrr.data.pop(),row_na_position=[0,1],col_na_position=[0,1,2],fData=[];for(var e=col_na_position.length;e<rrr.data.length;e++)fData.push(row_na_position.map(q=>rrr.data[e][q]));pData=jStat.transpose(col_na_position.concat([col_na_position.length]).map(q=>rrr.data[q])),pData.shift(),eData=[];var j=[...Array(rrr.data[0].length).keys()];j.shift(),j.shift();for(var e=col_na_position.length;e<rrr.data.length;e++)eData.push(j.map(q=>rrr.data[e][q]));eData.shift();var k=document.getElementById("warningMessage");k.innerHTML="";var n=jStat.sum(eData.map(q=>q.filter(r=>""==r)).map(q=>q.length));if(0<n){var o=document.createElement("p");o.setAttribute("style","color:orange;");var p=document.createTextNode("There are "+n+" missing values in your dataset. They are imputed by half-minimum of not missing value of the corresponding compound.");o.appendChild(p),k.appendChild(o)}if(-1===pData[0].indexOf("label")){var o=document.createElement("p");o.setAttribute("style","color:red;");var p=document.createTextNode("'label' is not found in your dataset. Check the example dataset.");o.appendChild(p),k.appendChild(o),num_error++}if(-1===pData[0].indexOf("batch")){var o=document.createElement("p");o.setAttribute("style","color:red;");var p=document.createTextNode("'batch' is not found in your dataset. Check the example dataset.");o.appendChild(p),k.appendChild(o),num_error++}if(-1===pData[0].indexOf("sampleType")){var o=document.createElement("p");o.setAttribute("style","color:red;");var p=document.createTextNode("'sampleType' is not found in your dataset. Check the example dataset.");o.appendChild(p),k.appendChild(o),num_error++}if(-1===pData[0].indexOf("time")){var o=document.createElement("p");o.setAttribute("style","color:red;");var p=document.createTextNode("'time' is not found in your dataset. Check the example dataset.");o.appendChild(p),k.appendChild(o),num_error++}if(sampleType_index=pData[0].indexOf("sampleType"),label_index=pData[0].indexOf("label"),qc_index=getAllIndexes(pData.map(q=>q[sampleType_index]),"qc"),sample_index=getAllIndexes(pData.map(q=>q[sampleType_index]),"sample"),1>qc_index.length){var o=document.createElement("p");o.setAttribute("style","color:red;");var p=document.createTextNode("'qc' is not found in your dataset. Check the example dataset.");o.appendChild(p),k.appendChild(o),num_error++}if(1>sample_index.length){var o=document.createElement("p");o.setAttribute("style","color:red;");var p=document.createTextNode("'qc' is not found in your dataset. Check the example dataset.");o.appendChild(p),k.appendChild(o),num_error++}if(batch_index=pData[0].indexOf("batch"),num_qc_per_batch=_.countBy(qc_index.map(q=>pData[q]).map(q=>q[batch_index])),1<Object.values(num_qc_per_batch).filter(q=>5>q).length){var o=document.createElement("p");o.setAttribute("style","color:red;");var p=document.createTextNode("Each batch must have at least five qc samples.");o.appendChild(p),k.appendChild(o),num_error++}0==num_error?($("#uploadedText").html("Congratuations! Data uploaded, ready to SERRF. Your data contains "+fData.length+" compounds, "+qc_index.length+" qcs and "+sample_index.length+" samples processed in "+Object.keys(num_qc_per_batch).length+" batches."),$("#apply").css("display","inline-block"),$("#apply").click(function(){var q=(fData.length/5.25).toFixed(0);$("#applyText").html("<span class=\"rainbow\"><i  class=\"fa fa-spinner fa-spin\" ></i> Estimated Calculation Time: "+q+" seconds.</span>"),$("#apply").prop("disabled",!0),console.log("!!!");var r=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf");r.get("initialize",{attachments:!0}).then(function(s){console.log("!!"),ddd=s,temp_index=Array.apply(null,{length:Math.min(pData.length-1,222)}).map(Number.call,Number),use_ex=twoArraysEqual(temp_index.map(t=>pData[t+1]).map(t=>t[label_index]),temp_index.map(t=>s.example_sample_label[t])),ex_normalized_data=ddd.example_normalized_data,ex_performance=unpack(ddd.example_normalized_data_performance,"after_QC_RSD"),ex_performance_table=ddd.example_normalized_data_performance,ex_after_PCA=ddd.example_after_PCA}).then(function(){console.log("!!"),$.getJSON("https://ipapi.co/json/",function(s){dta=s;new Date;project_id=Math.floor(Date.now()/1e3),console.log(project_id+" c! status: "+use_ex);var u={_id:project_id+"",dta:d.data,success:!1,feedback:!1,use_ex:use_ex};r.put(u).then(function(){$(".done").css("display","none"),pca_plot_url={};var v=eData.map(G=>G.map(H=>+H));before_pca=new ML.PCA(jStat.transpose(v),{scale:!0}),before_pca_scores=before_pca.predict(jStat.transpose(v));var w="PC 1 ("+(100*before_pca.getExplainedVariance()[0]).toFixed(2)+"%)",z="PC 2 ("+(100*before_pca.getExplainedVariance()[1]).toFixed(2)+"%)",A=before_pca_scores.map(G=>G[0]),B=before_pca_scores.map(G=>G[1]),C=pData.map(G=>G[sampleType_index]);C.shift();var D=Array(C.length).fill("");sample_label=pData.map(G=>G[label_index]),sample_label.shift();var E=score_plot(A,B,w,z,null,C,D,["red","rgba(0, 0, 0, 0)"],["circle"],["qc","sample"],[""],sample_label,6,!1,!1,!1);E.layout.title="Raw Data",Plotly.newPlot("before_pca",E.data,E.layout).then(function(G){Plotly.toImage(G,{format:"svg"}).then(function(H){uuu=H,uuu=uuu.replace(/^data:image\/svg\+xml,/,""),uuu=decodeURIComponent(uuu),pca_plot_url.before_score_plot=btoa(unescape(encodeURIComponent(uuu)))})}),"128.120.143.234"!==s.ip&&"2600:1700:e1c0:7870:ed85:c9ca:fb95:2f46"!==s.ip&&"168.150.116.196"!==s.ip&&"2600:1700:e1c0:7870:c1b7:6ecb:cbd5:6666"!==s.ip&&Email.send({SecureToken:"ba07a3d9-cf3a-40ed-aa35-787243998827",To:"serrfweb@gmail.com",From:"fansili2013@gmail.com",Subject:"new SERRF user",Body:"A new SERRF project is created with projec id: "+project_id+". IP: "+s.ip+". Status: "+use_ex}).then(function(){});var F=setInterval(function(){var G=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf");G.get(project_id,{attachments:!0}).then(function(H){if(ddd=H,ddd.failed)return $(".done").css("display","inline-block"),$("#applyText").html("Apply SERRF normalization"),$("#apply").prop("disabled",!1),alert("Calculation Failed. Error Message: "+ddd.error_message),void clearInterval(F);if(ddd.success){$(".done").css("display","inline-block"),$("#applyText").html("Apply SERRF normalization"),$("#apply").prop("disabled",!1),clearInterval(F),$("#count_less_20_SERRF").text(ddd.rsds.filter(S=>0.2>S).length),$("#perc_less_20_SERRF").text((100*(ddd.rsds.filter(S=>0.2>S).length/ddd.rsds.length)).toFixed(2)+"%"),$("#count_less_20_raw").text(ddd.before_rsds.filter(S=>0.2>S).length),$("#perc_less_20_raw").text((100*(ddd.before_rsds.filter(S=>0.2>S).length/ddd.before_rsds.length)).toFixed(2)+"%"),after_pca=new ML.PCA(jStat.transpose(ddd.normalized),{scale:!0}),after_pca_scores=after_pca.predict(jStat.transpose(ddd.normalized));var I="PC 1 ("+(100*after_pca.getExplainedVariance()[0]).toFixed(2)+"%)",J="PC 2 ("+(100*after_pca.getExplainedVariance()[1]).toFixed(2)+"%)",K=after_pca_scores.map(S=>S[0]),L=after_pca_scores.map(S=>S[1]),M=pData.map(S=>S[sampleType_index]);M.shift();var N=Array(M.length).fill(""),O=pData.map(S=>S[label_index]);O.shift();var P=score_plot(K,L,I,J,null,M,N,["red","rgba(0, 0, 0, 0)"],["circle"],["qc","sample"],[""],O,6,!1,!1,!1);P.layout.title="SERRF Normalized Data",Plotly.newPlot("after_pca",P.data,P.layout).then(function(S){Plotly.toImage(S,{format:"svg"}).then(function(T){uuu=T,uuu=uuu.replace(/^data:image\/svg\+xml,/,""),uuu=decodeURIComponent(uuu),pca_plot_url.after_score_plot=btoa(unescape(encodeURIComponent(uuu)))})});var Q=fData[0].indexOf("label");compound_label=fData.map(S=>S[Q]),compound_label.shift(),result_datatable=[];for(var R=0;R<ddd.rsds.length;R++)result_datatable.push({index:R,label:compound_label[R],before_QC_RSD:+ddd.before_rsds[R].toFixed(4),after_QC_RSD:+ddd.rsds[R].toFixed(4)});$("#feedback_yes").click(function(){var S=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf");S.get(project_id,{attachments:!0}).then(function(T){ddddd=T,T.feedback="yes",S.put(T),$("#feedback_response").text("Thank you! We are glad to hear that!"),$("#asking_feedback").css("display","none")})}),$("#feedback_no").click(function(){var S=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf");S.get(project_id,{attachments:!0}).then(function(T){ddddd=T,T.feedback="no",S.put(T),$("#feedback_response").html("Sorry to hear that! <a href='https://github.com/SERRFweb/app/issues' target='_blank'>Tell us what happend, please!</a>"),$("#asking_feedback").css("display","none")})}),$("#download").click(function(){$("#downloadText").text("Downloading..."),$("#download").prop("disabled",!0);for(var S=new JSZip,T=0;T<Object.keys(pca_plot_url).length;T++)S.file(Object.keys(pca_plot_url)[T]+".svg",Object.values(pca_plot_url)[T],{base64:!0});if("undefined"!=typeof plot_url)for(var T=0;T<plot_url.length;T++)S.file(T+".png",plot_url[T],{base64:!0});S.file("SERRF RSD table.csv",Papa.unparse(result_datatable)),result_normalized_data_object=[];for(var T=0;T<ddd.normalized.length;T++){temp_normalized=ddd.normalized[T];for(var U={label:gsub(".","_",[compound_label[T]])[0]},V=0;V<O.length;V++)U[gsub(".","_",[O[V]])[0]]=temp_normalized[V];result_normalized_data_object.push(U)}S.file("SERRF Normalized Data.csv",Papa.unparse(result_normalized_data_object)),S.generateAsync({type:"blob"}).then(function(W){var X=new Date;saveAs(W,"SERRF Normalization "+X.getTime()+".zip"),$("#downloadText").text("Download Results"),$("#download").prop("disabled",!1)})})}else console.log("Still waiting")})},5e3)})})})})):($("#uploadedText").html("upload failed."),$("#apply").css("display","none"))}})):void alert("Input data has to be in the .csv file. Please see the example dataset 'Explanation'.")})});